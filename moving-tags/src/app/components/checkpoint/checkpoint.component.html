<div class="container mt-4">
  <h2 class="mb-4">Checkpoint</h2>

  <ng-container *ngIf="tagSelected; else selectTagBlock">
    <div class="mb-3">
      <div class="d-flex align-items-center mb-2">
        <span class="fw-bold">Checkpoint:</span>
        <span class="ms-2 badge bg-primary">{{ selectedTag }}</span>
        <button class="btn btn-link ms-3" (click)="tagSelected = false">Switch to another checkpoint</button>
      </div>
    </div>
    <app-input-id (submitId)="onSubmitId($event)" (scanQr)="onScanQr()"></app-input-id>
    <div class="row mt-4">
      <div class="col-md-6">
        <h5>Remaining Items</h5>
        <ul class="list-group">
          <li *ngFor="let item of remaining" class="list-group-item d-flex justify-content-between align-items-center">
            <span (click)="onItemClick(item.id)" style="cursor:pointer;">{{ item.id }}</span>
            <button class="btn btn-sm btn-outline-primary ms-2" (click)="$event.stopPropagation(); openEdit(item.id)">Details</button>
          </li>
          <li *ngIf="remaining.length === 0" class="list-group-item text-muted">All items done!</li>
        </ul>
      </div>
      <div class="col-md-6">
        <h5>Done Items</h5>
        <ul class="list-group">
          <li *ngFor="let item of done" class="list-group-item d-flex justify-content-between align-items-center">
            <span (click)="onItemClick(item.id)" style="cursor:pointer;">{{ item.id }}</span>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary" (click)="$event.stopPropagation(); openEdit(item.id)">Details</button>
              <button class="btn btn-sm btn-outline-warning" (click)="$event.stopPropagation(); onUndoDone(item)">Undo</button>
            </div>
          </li>
          <li *ngIf="done.length === 0" class="list-group-item text-muted">No items done yet.</li>
        </ul>
      </div>
    </div>
    <!-- Popup for item info -->
    <div *ngIf="popupItem" class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.3);">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Item {{ popupItem.id }}</h5>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <span *ngFor="let tag of popupItem.itemTags" class="badge rounded-pill bg-primary me-1">{{ tag }}</span>
              <span *ngFor="let tag of popupItem.checklistTags" class="badge rounded-pill bg-info text-dark me-1">{{ tag }}</span>
            </div>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <img *ngFor="let photo of popupItem.photos" [src]="photo.data" class="img-thumbnail" style="max-width: 100px; max-height: 100px;" alt="Item photo">
              <span *ngIf="!popupItem.photos.length" class="text-muted">No photos</span>
            </div>
            <div class="mb-2 position-relative" style="height: 42px;">
              <div class="position-absolute top-0 start-0 w-100 h-100" style="z-index:0;">
                <div class="progress h-100" style="background: transparent;">
                  <div class="progress-bar bg-info" role="progressbar" [style.width.%]="popupProgress" [attr.aria-valuenow]="popupProgress" aria-valuemin="0" aria-valuemax="100" style="opacity:0.3;"></div>
                </div>
              </div>
              <div class="position-relative d-flex gap-2 justify-content-center align-items-center h-100" style="z-index:1;">
                <button class="btn btn-outline-secondary flex-fill" (click)="preventPopupClose()" [disabled]="popupPreventClose">
                  Keep
                </button>
                <button class="btn btn-outline-danger flex-fill" (click)="closePopup()">
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="popupItem" class="modal-backdrop fade show"></div>
  </ng-container>
  <ng-template #selectTagBlock>
    <div class="mb-3">
      <label for="tagInput" class="form-label">Checkpoint Tag</label>
      <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
        <ng-container *ngFor="let tag of tagList">
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="onSelectTag(tag)">{{ tag }}</button>
        </ng-container>
      </div>
      <input list="tagList" id="tagInput" class="form-control w-auto d-inline-block" style="max-width: 250px;" [(ngModel)]="tagInput" (ngModelChange)="onTagInputChange($event)">
      <datalist id="tagList">
        <option *ngFor="let tag of tagList" [value]="tag"></option>
      </datalist>
      <button class="btn btn-primary ms-2" (click)="onSelectTag(tagInput)" [disabled]="!tagInput">Select</button>
    </div>
    <div class="alert alert-info mt-4">Select or create a checkpoint tag to begin.</div>
  </ng-template>
</div>
