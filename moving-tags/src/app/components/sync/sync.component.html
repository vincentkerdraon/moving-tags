<div class="container mt-3">
  <h2>Sync Data</h2>
  <div class="row">
    <div class="col">
      <p class="text-muted">
        <strong>Your Device ID:</strong> {{ webrtc.deviceId }}
      </p>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="row">
    <div class="col">
      <div class="alert">
        Status:
        <span
          [ngClass]="{
            'text-success': network.connectionStatus === 'connected',
            'text-warning': network.connectionStatus === 'connecting',
            'text-info': network.connectionStatus === 'not connected'
          }"
        >
          {{ network.connectionStatus }}
        </span>
        <span
          *ngIf="
            network.connectionStatus === 'connected' && network.otherDeviceId
          "
        >
          <br />With Device ID: {{ network.otherDeviceId }} <br />
        </span>
        <button
          class="btn btn-sm btn-outline-secondary"
          (click)="cancelSync()"
          *ngIf="network.connectionStatus === 'connecting'"
        >
          Cancel
        </button>
        <button
          class="btn btn-sm btn-outline-secondary bg-white"
          (click)="cancelSync()"
          *ngIf="network.connectionStatus === 'connected'"
        >
          Disconnect
        </button>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mb-3" *ngIf="mode === 'default'">
    <div class="col">
      <button
        class="btn btn-primary me-2"
        (click)="startServer()"
        *ngIf="network.connectionStatus === 'not connected'"
      >
        Start as Server
      </button>
      <button
        class="btn btn-secondary me-2"
        (click)="connectToServer()"
        *ngIf="network.connectionStatus === 'not connected'"
      >
        Connect to Server
      </button>
      <button
        class="btn btn-success me-2"
        (click)="forceSync()"
        [disabled]="!canSync()"
      >
        Force Sync
      </button>
      <button class="btn btn-danger" (click)="confirmDeleteAll()">
        Delete All Data
      </button>
    </div>
  </div>

  <!-- Server Mode - Show QR Code -->
  <div
    class="row mb-3"
    *ngIf="mode === 'server' && network.connectionStatus === 'connecting'"
  >
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            Server Mode - Share the offer - Receive the answer
          </h5>
        </div>
        <div class="card-body">
          <h6>Server Offer</h6>
          <div *ngIf="canShowQr()">
            <div class="text-center">
              <app-webrtc-qr-code
                [data]="qrCodeData"
                [size]="qrCodeDisplaySize"
              ></app-webrtc-qr-code>
            </div>
            <div class="text-center">
              <button class="btn btn-outline-primary" (click)="copyQrData()">
                Copy QR Data
              </button>
            </div>
          </div>
          <div *ngIf="!canShowQr()" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Generating QR code...</span>
            </div>
            <p class="mt-2">Generating QR code...</p>
          </div>

          <!-- Server Answer Input (scan or paste, like client) -->
          <div class="" *ngIf="canShowQr()">
            <h6>Client Answer</h6>
            <p class="text-muted">
              Scan or paste the answer from the client device:
            </p>
            <div class="input-group">
              <button
                class="btn btn-outline-secondary fs-5"
                (click)="showScanner = true"
              >
                <span aria-hidden="true">▦</span>
              </button>
              <input
                type="text"
                class="form-control flex-grow-1"
                [(ngModel)]="serverAnswerInput"
                placeholder="Paste or scan client answer"
              />
              <button
                class="btn btn-outline-primary fs-5"
                (click)="onInputServerAnswer()"
                [disabled]="!serverAnswerInput.trim()"
              >
                <span aria-hidden="true">✨</span>
              </button>
            </div>
          </div>

          <!-- QR Scanner Modal (shared for both client/server) -->
          <app-qr-scanner
            *ngIf="showScanner"
            (scanResult)="onScanServerAnswer($event)"
            (close)="showScanner = false"
          >
          </app-qr-scanner>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Mode - Need server offer: Scan QR Code or Paste -->
  <div
    class="row mb-3"
    *ngIf="mode === 'client' && network.connectionStatus === 'connecting'"
  >
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Client Mode - Enter or Scan Server Offer</h5>
        </div>
        <div class="card-body">
          <div *ngIf="!clientAnswer">
            <div class="mb-2 alert alert-info">
              On the other device, "start as server".<br />
              This server will generate an "offer".
            </div>
            <div class="input-group">
              <button
                class="btn btn-outline-secondary fs-5"
                (click)="onScanQr()"
              >
                <span aria-hidden="true">▦</span>
              </button>
              <input
                type="text"
                class="form-control flex-grow-1"
                [(ngModel)]="pastedOffer"
                placeholder="Enter or scan server offer"
              />
              <button
                class="btn btn-outline-primary fs-5"
                (click)="onProcessPastedOffer()"
                [disabled]="!pastedOffer.trim()"
              >
                <span aria-hidden="true">✨</span>
              </button>
            </div>
            <!-- QR Scanner Modal (shared for both client/server) -->
            <app-qr-scanner
              *ngIf="showScanner"
              (scanResult)="onScanResult($event)"
              (close)="showScanner = false"
            >
            </app-qr-scanner>
          </div>
          <div *ngIf="clientAnswer">
            <div class="mb-2 alert alert-info">
              The offer is valid, here is the answer to transmit to the server.
            </div>
            <div class="text-center mb-3">
              <app-webrtc-qr-code
                [data]="compressAnswer(clientAnswer)"
                [size]="qrCodeDisplaySize"
              ></app-webrtc-qr-code>
            </div>
            <div class="text-center">
              <button
                class="btn btn-outline-primary"
                (click)="copyCompressedAnswer()"
              >
                Copy QR Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Display -->
  <div class="row mb-3" *ngIf="errorMessage">
    <div class="col">
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ errorMessage }}
        <button
          type="button"
          class="btn-close float-end"
          (click)="errorMessage = null"
        ></button>
      </div>
    </div>
  </div>

  <!-- Sync Status Table -->
  <div class="row mb-3" *ngIf="allClients.length > 0">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Sync Status</h5>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Device</th>
                <th class="d-none d-md-table-cell">Last Sync</th>
                <th>Photos</th>
                <th>Changes</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let client of allClients">
                <td>
                  <div>
                    {{
                      client === webrtc.deviceId ? client + " (You)" : client
                    }}
                  </div>
                  <div class="d-md-none text-muted small">
                    {{
                      syncService.getLastSync(client)
                        ? (syncService.getLastSync(client) | date : "short")
                        : "Never"
                    }}
                  </div>
                </td>
                <td class="d-none d-md-table-cell">
                  {{
                    syncService.getLastSync(client)
                      ? (syncService.getLastSync(client) | date : "short")
                      : "Never"
                  }}
                </td>
                <td>{{ getPhotoCount(client) }}</td>
                <td>{{ getItemChangeCount(client) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
