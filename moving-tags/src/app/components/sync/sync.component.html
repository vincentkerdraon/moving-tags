<div class="container mt-4">
  <h2>Sync Status</h2>
  <div class="mb-3">
    <strong>Your Client ID:</strong> {{ syncService.clientId }}
  </div>

  <div *ngIf="mode === 'default'">
    <button class="btn btn-primary me-2" (click)="startServer()">
      Start new server
    </button>
    <button class="btn btn-primary" (click)="connectToServer()">
      Connect to server
    </button>
  </div>

  <div *ngIf="mode === 'server'">
    <div class="row">
      <div class="col-md-6">
        <h4>Start New Server</h4>
        <ol>
          <li>Generating a QR code...</li>
          <li>
            On the other device, scan the QR code and follow the instructions to
            complete the connection.
          </li>
          <li>Connection status will be shown below.</li>
        </ol>
        <div class="mt-3">
          <span class="fw-bold">Status:</span>
          <span class="badge bg-{{ getStatusInfo().badge }} ms-2">{{
            getStatusInfo().label
          }}</span>
        </div>

        <div class="mt-3" *ngIf="isConnectionReady()">
          <label for="testMessage" class="form-label">Send test message:</label>
          <div class="input-group">
            <input
              id="testMessage"
              type="text"
              class="form-control"
              [(ngModel)]="testMessage"
              placeholder="Type a message..."
              (keyup.enter)="sendTestMessage()"
            />
            <button
              class="btn btn-primary"
              (click)="sendTestMessage()"
              [disabled]="!testMessage.trim()"
            >
              Send
            </button>
          </div>
        </div>

        <button class="btn btn-secondary mt-3" (click)="cancelSync()">
          Cancel
        </button>
      </div>
      <div class="col-md-6">
        <div *ngIf="syncService.connectionStarted">
          <div *ngIf="syncService.qrData">
            <app-webrtc-qr-code
              [data]="syncService.qrData"
            ></app-webrtc-qr-code>
          </div>
          <div *ngIf="syncService.rawOffer">
            <button
              class="btn btn-outline-secondary btn-sm d-block mx-auto"
              (click)="copyRawOffer()"
            >
              Copy raw offer
            </button>
          </div>

          <div class="mt-3" *ngIf="syncService.rawOffer">
            <label for="answerInput" class="form-label"
              >Paste code from the other device:</label
            >
            <input
              id="answerInput"
              type="text"
              class="form-control"
              [(ngModel)]="serverAnswerInput"
              placeholder="Paste the code from the other device..."
            />
            <button
              class="btn btn-success btn-sm mt-2"
              (click)="processClientAnswer()"
              [disabled]="!serverAnswerInput"
            >
              Finish Connection
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="mode === 'client'">
    <div class="row">
      <div class="col-md-6">
        <h4>Connect to Server</h4>
        <ol>
          <li>Scan the QR code displayed on the server device, OR</li>
          <li>Paste the offer JSON in the text area below.</li>
          <li>Follow the instructions to complete the connection.</li>
        </ol>

        <div class="mb-3">
          <label for="offerInput" class="form-label"
            >Or paste offer JSON here:</label
          >
          <input
            id="offerInput"
            type="text"
            class="form-control"
            [(ngModel)]="pastedOffer"
            placeholder="Paste the JSON offer from the server device..."
          />
          <button
            class="btn btn-success btn-sm mt-2"
            (click)="onProcessPastedOffer()"
            [disabled]="!pastedOffer"
          >
            Process Offer
          </button>
        </div>

        <div class="mt-3">
          <span class="fw-bold">Status:</span>
          <span class="badge bg-{{ getStatusInfo().badge }} ms-2">{{
            getStatusInfo().label
          }}</span>
        </div>

        <div class="mt-3" *ngIf="isConnectionReady()">
          <label for="testMessageClient" class="form-label"
            >Send test message:</label
          >
          <div class="input-group">
            <input
              id="testMessageClient"
              type="text"
              class="form-control"
              [(ngModel)]="testMessage"
              placeholder="Type a message..."
              (keyup.enter)="sendTestMessage()"
            />
            <button
              class="btn btn-primary"
              (click)="sendTestMessage()"
              [disabled]="!testMessage.trim()"
            >
              Send
            </button>
          </div>
        </div>

        <button class="btn btn-secondary mt-3" (click)="cancelSync()">
          Cancel
        </button>
      </div>
      <div class="col-md-6">
        <zxing-scanner
          (scanSuccess)="onQrCodeResult($event)"
          [torch]="false"
          [enable]="true"
          [tryHarder]="true"
        >
        </zxing-scanner>
        <div *ngIf="scannedQr" class="mt-3">
          <div class="alert alert-success">
            <strong>QR Code Scanned:</strong><br />
            <small>{{ scannedQr }}</small>
          </div>
        </div>

        <div class="mt-3" *ngIf="clientAnswer">
          <div class="alert alert-info">
            <strong>Ready!</strong><br />
            Copy this code to the other device to finish connecting:
            <button
              class="btn btn-outline-primary btn-sm d-block mt-2"
              (click)="copyClientAnswer()"
            >
              Copy Code
            </button>
            <pre class="small bg-light p-2 border rounded mt-2">{{
              clientAnswer
            }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <table class="table table-bordered mt-4">
    <thead>
      <tr>
        <th>Client</th>
        <th>Last Sync</th>
        <th>Photos Since Last Sync</th>
        <th>Item Changes Since Last Sync</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let client of allClients">
        <td>
          {{ client === syncService.clientId ? client + " (You)" : client }}
        </td>
        <td>
          {{
            syncService.lastSync[client]
              ? (syncService.lastSync[client] | date : "short")
              : "Never"
          }}
        </td>
        <td>{{ getPhotoCount(client) }}</td>
        <td>{{ getItemChangeCount(client) }}</td>
      </tr>
    </tbody>
  </table>
</div>
