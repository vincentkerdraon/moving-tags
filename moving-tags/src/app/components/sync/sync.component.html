<div class="container mt-4">
  <h2>Sync Status</h2>
  <div class="text-muted small">
    <strong>Your Device ID:</strong> {{ syncService.deviceId }}
  </div>
  <div class="mb-3">
    <strong>Status:</strong>
    <span class="badge bg-{{ getStatusInfo().badge }} ms-2">{{
      getStatusInfo().label
    }}</span>
  </div>

  <div
    *ngIf="
      mode === 'default' &&
      syncService.connectionStatus !== SyncConnectionStatus.Client_Connected &&
      syncService.connectionStatus !== SyncConnectionStatus.Server_Connected
    "
  >
    <button class="btn btn-primary me-2" (click)="startServer()">
      Start new server
    </button>
    <button class="btn btn-primary" (click)="connectToServer()">
      Connect to server
    </button>
  </div>

  <div
    *ngIf="
      mode !== 'default' &&
      syncService.connectionStatus !== SyncConnectionStatus.Client_Connected &&
      syncService.connectionStatus !== SyncConnectionStatus.Server_Connected
    "
  >
    <button class="btn btn-secondary mb-3" (click)="cancelSync()">
      Cancel connection
    </button>
  </div>

  <div
    *ngIf="
      syncService.connectionStatus === SyncConnectionStatus.Client_Connected ||
      syncService.connectionStatus === SyncConnectionStatus.Server_Connected
    "
  >
    <button class="btn btn-secondary mb-3" (click)="cancelSync()">
      Disconnect
    </button>
  </div>

  <div
    *ngIf="
      mode === 'server' &&
      syncService.connectionStatus !== SyncConnectionStatus.Server_Connected
    "
  >
    <div class="row">
      <div class="col-md-6">
        <h4>Start New Server</h4>
        <div class="alert alert-info">
          <ol>
            <li>
              On the client device, in "Sync" tab, select "Connect to server".
            </li>
            <li>Scan this QR code and follow the instructions.</li>
            <li>Scan the QR code displayed on the client device, OR</li>
            <li>Paste the answer here.</li>
          </ol>
        </div>
        <input
          id="answerInput"
          type="text"
          class="form-control"
          [(ngModel)]="serverAnswerInput"
          placeholder="Paste the code from the other device..."
        />
        <button
          class="btn btn-success btn-sm mt-2"
          (click)="processClientAnswer()"
          [disabled]="!serverAnswerInput"
        >
          Finish Connection
        </button>
      </div>
      <div class="col-md-6">
        <div *ngIf="syncService.connectionStarted">
          <div *ngIf="syncService.qrData">
            <app-webrtc-qr-code
              [data]="syncService.qrData"
            ></app-webrtc-qr-code>
          </div>
          <div *ngIf="syncService.rawOffer">
            <button
              class="btn btn-outline-secondary btn-sm d-block mx-auto"
              (click)="copyRawOffer()"
            >
              Copy offer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div
    *ngIf="
      mode === 'client' &&
      syncService.connectionStatus !== SyncConnectionStatus.Client_Connected
    "
  >
    <h4>Connect to Server</h4>
    <div *ngIf="!clientAnswer">
      <div class="alert alert-info">
        <ol>
          <li>
            Scan the QR code displayed on the server device using the camera
            below, OR
          </li>
          <li>Paste the offer in the text field.</li>
        </ol>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <label for="offerInput" class="form-label">Paste JSON Offer</label>
            <input
              id="offerInput"
              type="text"
              class="form-control"
              [(ngModel)]="pastedOffer"
              placeholder="Paste the JSON offer from the server device..."
            />
            <button
              class="btn btn-success btn-sm mt-2"
              (click)="onProcessPastedOffer()"
              [disabled]="!pastedOffer"
            >
              Process Offer
            </button>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Or Scan QR Code</label>

          <!-- Error Message Display -->
          @if (errorMessage) {
          <div
            class="alert alert-danger alert-dismissible fade show mb-2"
            role="alert"
          >
            <strong>Scan Error:</strong> {{ errorMessage }}
            <button
              type="button"
              class="btn-close"
              aria-label="Close"
              (click)="errorMessage = null"
            ></button>
          </div>
          }

          <div
            class="border rounded p-2"
            style="
              min-height: 300px;
              display: flex;
              flex-direction: column;
              align-items: center;
            "
          >
            <div style="max-width: 400px; width: 100%">
              <zxing-scanner
                (scanSuccess)="onQrCodeResult($event)"
                (scanError)="onScanError($event)"
                (scanFailure)="onScanFailure($event)"
                (scanComplete)="onScanComplete($event)"
                (camerasFound)="onCamerasFound($event)"
                (camerasNotFound)="onCamerasNotFound()"
                (permissionResponse)="onPermissionResponse($event)"
                [torch]="false"
                [enable]="true"
                [tryHarder]="true"
                [timeBetweenScans]="500"
                style="
                  max-width: 100%;
                  max-height: 250px;
                  width: 100%;
                  flex-shrink: 0;
                "
              >
              </zxing-scanner>
            </div>
          </div>
          <div *ngIf="scannedQr" class="mt-2">
            <div class="alert alert-success">
              <strong>QR Code Scanned Successfully!</strong><br />
              <small>Processing connection data...</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-3" *ngIf="clientAnswer">
      <div class="alert alert-info">
        <span
          >Scan this QR code or copy the code below to the server to finish
          connecting:</span
        >
      </div>
      <div class="d-flex justify-content-center">
        <app-webrtc-qr-code [data]="clientAnswer"></app-webrtc-qr-code>
      </div>
      <button
        class="btn btn-outline-secondary btn-sm d-block mx-auto"
        (click)="copyClientAnswer()"
      >
        Copy Code
      </button>
    </div>
  </div>

  <div
    *ngIf="
      syncService.connectionStatus === SyncConnectionStatus.NotConnected ||
      syncService.connectionStatus === SyncConnectionStatus.Client_Connected ||
      syncService.connectionStatus === SyncConnectionStatus.Server_Connected
    "
  >
    <div class="table-responsive">
      <table class="table table-bordered mt-4">
        <thead>
          <tr>
            <th>Device</th>
            <th class="d-none d-md-table-cell">Last Sync</th>
            <th>Photos</th>
            <th>Changes</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let client of allClients">
            <td>
              <div>
                {{
                  client === syncService.deviceId ? client + " (You)" : client
                }}
              </div>
              <div class="d-md-none text-muted small">
                {{
                  syncService.lastSync[client]
                    ? (syncService.lastSync[client] | date : "short")
                    : "Never"
                }}
              </div>
            </td>
            <td class="d-none d-md-table-cell">
              {{
                syncService.lastSync[client]
                  ? (syncService.lastSync[client] | date : "short")
                  : "Never"
              }}
            </td>
            <td>{{ getPhotoCount(client) }}</td>
            <td>{{ getItemChangeCount(client) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
