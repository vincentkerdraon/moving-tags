<div class="container mt-3">
  <!-- Header -->
  <div class="row mb-3">
    <div class="col">
      <h2>Sync Data</h2>
      <p class="text-muted">
        <strong>Your Device ID:</strong> {{ webrtc.deviceId }}
      </p>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="row mb-3">
    <div class="col">
      <div
        class="alert"
        [ngClass]="{
          'alert-success': isConnected,
          'alert-warning': !isConnected && mode !== 'default',
          'alert-info': mode === 'default'
        }"
      >
        <strong>Status:</strong> {{ getConnectionStatus() }}
        <button
          *ngIf="isConnected"
          class="btn btn-sm btn-outline-primary ms-2"
          (click)="forceReconnect()"
        >
          Force Reconnect
        </button>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="row mb-3" *ngIf="mode === 'default'">
    <div class="col">
      <button class="btn btn-primary me-2" (click)="startServer()">
        Start as Server
      </button>
      <button class="btn btn-secondary me-2" (click)="connectToServer()">
        Connect to Server
      </button>
      <button
        class="btn btn-success me-2"
        (click)="forceSync()"
        [disabled]="!canSync()"
      >
        Force Sync
      </button>
      <button class="btn btn-danger" (click)="confirmDeleteAll()">
        Delete All Data
      </button>
    </div>
  </div>

  <!-- Server Mode - Show QR Code -->
  <div class="row mb-3" *ngIf="mode === 'server'">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Server Mode - Share this QR Code</h5>
        </div>
        <div class="card-body">
          <div *ngIf="canShowQr()">
            <app-webrtc-qr-code [data]="qrCodeData" [size]="256">
            </app-webrtc-qr-code>
            <div class="mt-3">
              <button
                class="btn btn-outline-primary me-2"
                (click)="copyQrData()"
              >
                Copy QR Data
              </button>
              <button class="btn btn-secondary" (click)="cancelSync()">
                Cancel
              </button>
            </div>
          </div>
          <div *ngIf="!canShowQr()" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Generating QR code...</span>
            </div>
            <p class="mt-2">Generating QR code...</p>
          </div>

          <!-- Server Answer Input -->
          <div class="mt-4" *ngIf="canShowQr()">
            <h6>Client Answer</h6>
            <p class="text-muted">Paste the answer from the client device:</p>
            <textarea
              class="form-control mb-2"
              rows="4"
              [(ngModel)]="serverAnswerInput"
              placeholder="Paste client answer here..."
            >
            </textarea>
            <button
              class="btn btn-success"
              (click)="onProcessServerAnswer()"
              [disabled]="!canProcessAnswer()"
            >
              Process Answer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Mode - Scan QR or Paste Offer -->
  <div class="row mb-3" *ngIf="mode === 'client'">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Client Mode - Scan QR Code or Paste Offer</h5>
        </div>
        <div class="card-body">
          <!-- QR Scanner -->
          <div class="mb-3">
            <h6>Scan QR Code</h6>
            <zxing-scanner
              [enable]="true"
              (scanSuccess)="onQrCodeResult($event)"
              [formats]="allowedFormats"
            >
            </zxing-scanner>
          </div>

          <!-- Manual Paste -->
          <div class="mb-3">
            <h6>Or Paste Offer Data</h6>
            <textarea
              class="form-control mb-2"
              rows="4"
              [(ngModel)]="pastedOffer"
              placeholder="Paste server offer here..."
            >
            </textarea>
            <button
              class="btn btn-primary me-2"
              (click)="onProcessPastedOffer()"
              [disabled]="!pastedOffer.trim()"
            >
              Connect
            </button>
            <button class="btn btn-secondary" (click)="cancelSync()">
              Cancel
            </button>
          </div>

          <!-- Client Answer Display -->
          <!-- Server Offer Display (decompressed) -->
          <div
            *ngIf="
              mode === 'client' && pastedOffer && pastedOffer.startsWith('v=')
            "
            class="mt-4"
          >
            <h6>Server Offer (decompressed)</h6>
            <textarea
              class="form-control mb-2"
              rows="4"
              [value]="pastedOffer"
              readonly
            ></textarea>
          </div>
          <div *ngIf="canCopyAnswer()" class="mt-4">
            <h6>Your Answer</h6>
            <p class="text-muted">
              Copy this answer and send it to the server, or scan the QR code:
            </p>
            <app-webrtc-qr-code
              [data]="compressAnswer(clientAnswer)"
              [size]="256"
              class="mb-3"
            ></app-webrtc-qr-code>
            <textarea
              class="form-control mb-2"
              rows="4"
              [value]="compressAnswer(clientAnswer)"
              readonly
            >
            </textarea>
            <button
              class="btn btn-success me-2"
              (click)="copyCompressedAnswer()"
            >
              Copy Compressed Answer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Display -->
  <div class="row mb-3" *ngIf="errorMessage">
    <div class="col">
      <div class="alert alert-danger">
        <strong>Error:</strong> {{ errorMessage }}
        <button
          type="button"
          class="btn-close float-end"
          (click)="errorMessage = null"
        ></button>
      </div>
    </div>
  </div>

  <!-- Sync Status Table -->
  <div class="row mb-3" *ngIf="allClients.length > 0">
    <div class="col">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Sync Status</h5>
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Device</th>
                <th class="d-none d-md-table-cell">Last Sync</th>
                <th>Photos</th>
                <th>Changes</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let client of allClients">
                <td>
                  <div>
                    {{
                      client === webrtc.deviceId ? client + " (You)" : client
                    }}
                  </div>
                  <div class="d-md-none text-muted small">
                    {{
                      syncService.getLastSync(client)
                        ? (syncService.getLastSync(client) | date : "short")
                        : "Never"
                    }}
                  </div>
                </td>
                <td class="d-none d-md-table-cell">
                  {{
                    syncService.getLastSync(client)
                      ? (syncService.getLastSync(client) | date : "short")
                      : "Never"
                  }}
                </td>
                <td>{{ getPhotoCount(client) }}</td>
                <td>{{ getItemChangeCount(client) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
